---
- name: Install and configure MySQL on Ubuntu nodes
  hosts: nodes  # Target the 'nodes' group defined in your inventory
  become: true  # Use sudo to escalate privileges
  become_user: root  # Run as root after sudo

  tasks:
    - name: Install MySQL Server
      apt:
        name: mysql-server
        state: present
        update_cache: yes  # Update apt cache before installing

    - name: Ensure MySQL service is started and enabled
      systemd:
        name: mysql
        state: started
        enabled: true

    - name: Secure MySQL installation (set root password)
      mysql_user:
        name: root
        password: "{{ mysql_root_password }}"  # Set a secure password for the MySQL root user
        host: "localhost"
        state: present
      when: mysql_root_password is defined

    - name: Allow remote connections to MySQL (optional)
      lineinfile:
        path: /etc/mysql/mysql.conf.d/mysqld.cnf
        regexp: '^#bind-address'
        line: 'bind-address = 0.0.0.0'
      notify:
        - Restart MySQL

  handlers:
    - name: Restart MySQL
      systemd:
        name: mysql
        state: restarted
